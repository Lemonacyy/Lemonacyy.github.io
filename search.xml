<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>log与原子DDL的实现</title>
      <link href="/2023/12/13/log%E4%B8%8E%E5%8E%9F%E5%AD%90DDL%E7%9A%84%E5%AE%9E%E7%8E%B0/"/>
      <url>/2023/12/13/log%E4%B8%8E%E5%8E%9F%E5%AD%90DDL%E7%9A%84%E5%AE%9E%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>原子性，通俗来说就是指一条命令要么全部执行，要么全部不执行。</p><p>当我们使用MySQL来存储应用数据的时候，MySQL同样也需要存储这些元数据。在MySQL8.0之前的版本中，这些元数据被存放在许多不同的文件中（.FRM，.PAR，.OPT，.TRN，.TRG文件等），这就导致了一系列弊端，包括数据可能不一致、API接口的复杂性等等，在之前的月报<a href="http://mysql.taobao.org/monthly/2018/03/02/">[5]</a>中也有详细描述。元数据被放在许多不同的文件中，导致数据可能不一致的具体表现为：</p><ol><li>Server层的metadata和Storage Engine层的metadata数据不一致；</li><li>InnoDB中的metadata和数据不一致；</li><li>Binlog和数据不一致。</li></ol><span id="more"></span><img src="/2023/12/13/log%E4%B8%8E%E5%8E%9F%E5%AD%90DDL%E7%9A%84%E5%AE%9E%E7%8E%B0/dd_before_80.png" class="" title="MySQL8.0之前的元数据持久化存储方案"><p>也是由于上述原因，MySQL一开始并没能实现DDL的原子性操作，举例来说，我们创建表时如果发生crash，建表不完整，可能会遗留下ibd文件或者.frm文件，这些文件不仅浪费了表空间，还有可能对后续的DDL操作造成影响。</p><p>为了实现AtomicDDL，MySQL 8.0进行了大刀阔斧的改革，目前，只有InnoDB存储引擎支持原子DDL。</p><p>MySQL8.0之后，分散的元数据被统一存放在Data Dictionary中，用户、Server层、引擎都可以通过DD的访问接口查询或者更新Metadata。与DD表有关的源码阅读可以参考之前的月报<a href="http://mysql.taobao.org/monthly/2018/03/02/">[5]</a>。</p><img src="/2023/12/13/log%E4%B8%8E%E5%8E%9F%E5%AD%90DDL%E7%9A%84%E5%AE%9E%E7%8E%B0/dd_in_80.png" class="" title="MySQL8.0的元数据持久化存储方案"><p>此外，（以下全针对InnoDB存储引擎）还引入了一个特殊的数据结构DDL_log。InnoDB中通过DDL_log来保证DDL的原子性。在DDL执行期间跟踪文件和结构的创建，然后在提交&#x2F;回滚时使用它来正确清理。</p><h2 id="DDL-log"><a href="#DDL-log" class="headerlink" title="DDL log"></a>DDL log</h2><p>为了实现原子DDL的提交和回滚，InnoDB存储引擎引入了一个表DDL_LOG，这是一个受保护的表，不允许外部用户查询和修改，包括对该表进行DDL以及DML。该表用来存储DDL执行期间InnoDB存储引擎需要对物理文件以及相关系统表操作的记录，对于添加到DDL_LOG的每一条记录，都会附加一个trx_id（事务id），因此在提交&#x2F;回滚时，可以用事务标识这些条目，并采取适当的操作。在InnoDB提交&#x2F;回滚和相应的操作之后，事务的所有记录将从DDL_LOG中删除。为了保证SERVER crash的时候DDL还能支持原子性，这个表必须尽快持久化，它需要进行同步刷新，不受<code>innodb_flush_log_at_trx_commit</code>的控制。</p><p>DDL Log Table的定义如下：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE mysql.<span class="built_in">innodb_ddl_log</span> (</span><br><span class="line">  id BIGINT UNSIGNED NOT <span class="literal">NULL</span> AUTO_INCREMENT PRIMARY KEY, <span class="comment">// DDL log记录的唯一标志符</span></span><br><span class="line">  thread_id BIGINT UNSIGNED NOT <span class="literal">NULL</span>, <span class="comment">// 每个DDL日志记录分配一个thread_id，用于重放和删除属于特定DDL操作的DDL日志</span></span><br><span class="line">  type INT UNSIGNED NOT <span class="literal">NULL</span>, <span class="comment">// DDL操作的类型，包括FREE RENAME等</span></span><br><span class="line">  space_id INT UNSIGNED, <span class="comment">// 表空间的id</span></span><br><span class="line">  page_no INT UNSIGNED, <span class="comment">// 包含分配信息的页，比如索引树的root</span></span><br><span class="line">  index_id BIGINT UNSIGNED, <span class="comment">// 索引id</span></span><br><span class="line">  table_id BIGINT UNSIGNED, <span class="comment">// 表id</span></span><br><span class="line">  old_file_path <span class="built_in">VARCHAR</span>(<span class="number">512</span>) COLLATE UTF8_BIN, <span class="comment">// 旧的表空间文件路径，用于创建或删除表空间文件的DDL操作，也用于重命名表空间的DDL操作</span></span><br><span class="line">  new_file_path <span class="built_in">VARCHAR</span>(<span class="number">512</span>) COLLATE UTF8_BIN, <span class="comment">// 新的表空间文件路径，用于重命名表空间文件的DDL操作。</span></span><br><span class="line">  <span class="built_in">KEY</span>(thread_id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>DDL语句的执行分为以下几个阶段，有时候prepare和perform阶段可以在commit之前反复执行：</p><ol><li>prepare：创建所需的对象并把DDL log写入<code>mysql.innodb_ddl_log</code>；</li><li>perform：执行DDL操作；</li><li>commit：更新数据字典并提交数据字典事务；</li><li>Post-DDL：重放和从<code>mysql.innodb_ddl_log</code>中删除DDL log。</li></ol><p>DDL操作类型如下：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum class</span> <span class="title class_">Log_Type</span> : <span class="type">uint32_t</span> &#123;</span><br><span class="line">  <span class="comment">/** Smallest log type */</span></span><br><span class="line">  SMALLEST_LOG = <span class="number">1</span>,</span><br><span class="line">  <span class="comment">/** Drop an index tree */</span></span><br><span class="line">  FREE_TREE_LOG = <span class="number">1</span>,</span><br><span class="line">  <span class="comment">/** Delete a file */</span></span><br><span class="line">  DELETE_SPACE_LOG,</span><br><span class="line">  <span class="comment">/** Rename a file */</span></span><br><span class="line">  RENAME_SPACE_LOG,</span><br><span class="line">  <span class="comment">/** Drop the entry in innodb_table_metadata */</span></span><br><span class="line">  DROP_LOG,</span><br><span class="line">  <span class="comment">/** Rename table in dict cache. */</span></span><br><span class="line">  RENAME_TABLE_LOG,</span><br><span class="line">  <span class="comment">/** Remove a table from dict cache */</span></span><br><span class="line">  REMOVE_CACHE_LOG,</span><br><span class="line">  <span class="comment">/** Alter Encrypt a tablespace */</span></span><br><span class="line">  ALTER_ENCRYPT_TABLESPACE_LOG,</span><br><span class="line">  <span class="comment">/** Biggest log type */</span></span><br><span class="line">  BIGGEST_LOG = ALTER_ENCRYPT_TABLESPACE_LOG</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ol><li>FREE_TREE_LOG：删除指定的索引。</li><li>DELETE_SPACE_LOG：删除指定的idb表空间文件。</li><li>RENAME_SPACE_LOG：删除指定的idb表空间文件。</li><li>DROP_LOG：从<code>mysql.innodb_dynamic_metadata</code>表中删除指定表的信息。</li><li>RENAME_TABLE_LOG：重命名dictionary cache中的表。</li><li>REMOVE_CACHE_LOG：删除dictionary cache中指定的表。</li><li>ALTER_ENCRYPT_TABLESPACE_LOG：用于记录对tablespace加密属性的修改。</li></ol><p>DDL Log可以看作是Redo Log和Undo Log的一个合集。有些DDL把它用作Redo，有些DDL把它用做Undo，还有些DDL会把它同时当作Redo和Undo。有些DDL log是随着父事务一起提交的，有些则在Post-DDL阶段再执行，Post-DDL发生在父事提交或回滚之后，若事务回滚，根据DDL log做逆操作，若事务提交，在Post-DDL阶段做最后真正不可逆操作，在之后的小节会针对典型命令的操作过程进行分析。</p><h2 id="CREATE-TABLE的执行"><a href="#CREATE-TABLE的执行" class="headerlink" title="CREATE TABLE的执行"></a>CREATE TABLE的执行</h2><p>执行一条最简单的CREATE TABLE，来分析整个的代码执行逻辑。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> t1(a <span class="type">int</span>);</span><br></pre></td></tr></table></figure><p>创建表的执行过程如下：</p><ol><li>在SQL层，创建表对象（Table Object），然后对SE（Storage Engine）进行初始函数调用，以便SE能够初始化它对DDL的处理；</li><li>SE添加它此时拥有的SE私有数据，并将控制权返回给SQL层；</li><li>然后将表存储在DD表中。对于支持原子DDL的存储引擎来说，此时还没有提交；</li><li>SQL层构建所有的内部结构，然后调用SE层的建表函数；</li><li>SE创建表空间&#x2F;表&#x2F;索引树，在DDL_LOG中记录上述物理文件和创建的索引，更新SE私有数据，并将控制权返回给SQL层。所有关于新表空间&#x2F;索引的信息都通过DD对象传递给server层；</li><li>SQL层写入二进制日志，并根据执行状态提交或回滚事务；</li><li>SQL层在SE中调用一个post_ddl()的钩子函数对文件和树进行适当的清理，并删除事务的DDL_LOG中的条目。如果事务回滚，则post_ddl()会删除表空间和索引树。</li></ol><p>详细地调用流程为：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">mysql_create_table</span><br><span class="line">    --&gt; mysql_create_table_no_lock</span><br><span class="line">        --&gt; create_table_impl</span><br><span class="line">            --&gt; rea_create_base_table</span><br><span class="line">                --&gt; dd::create_table  //创建dd::Table</span><br><span class="line">                |    --&gt; dd::create_dd_user_table / dd::create_dd_system_table </span><br><span class="line">                |        // 根据create_info填充dd::Table</span><br><span class="line">                --&gt; dd::cache::Dictionary_client::store&lt;dd::Table&gt; </span><br><span class="line">                |   // 判断dd:Table是否已经存入数据字典，如果没有才进入这个函数</span><br><span class="line">                |    --&gt; dd::cache::Storage_adapter::store&lt;dd::Table&gt; // 将创建好的dd:Table存入dd表</span><br><span class="line">                |        --&gt; dd::Weak_object_impl::store</span><br><span class="line">                |            --&gt; dd::Table_impl::store_attributes // 更新mysql.tables</span><br><span class="line">                |            --&gt; dd::Table_impl::store_children </span><br><span class="line">                |                // 更新建表相关的数据字典表如indexes，foreign_keys，partitions</span><br><span class="line">                --&gt; ha_create_table // 实际创建表</span><br><span class="line">                    --&gt; handler::ha_create</span><br><span class="line">                    |    --&gt; ha_innobase::create // 创建InnoDB表</span><br><span class="line">                    |        --&gt; innobase_basic_ddl::create_impl&lt;dd::Table&gt;</span><br><span class="line">                    |            --&gt; create_table_info_t::create_table</span><br><span class="line">                    |            |    --&gt; create_table_info_t::create_table_def </span><br><span class="line">                    |            |    |   // 创建基于InnoDB数据库的表定义，检查表名是否合规</span><br><span class="line">                    |            |    |   // 确定列数之后，在内存中创建了空的表</span><br><span class="line">                    |            |    |    --&gt; dict_mem_table_create</span><br><span class="line">                    |            |    |       // 在内存中创建表对象（空的，只申请了空间），设置了表的一些参数</span><br><span class="line">                    |            |    |   // 然后对这张表进行了基础的填充，包括设定一些名称、为表加列</span><br><span class="line">                    |            |    |   // 此时还没有对应的idb文件生成</span><br><span class="line">                    |            |    |    --&gt; row_create_table_for_mysql</span><br><span class="line">                    |            |    |       --&gt; dict_build_table_def // 在不更新系统表的情况下创建表定义definition</span><br><span class="line">                    |            |    |       |    --&gt; dict_build_tablespace_for_table </span><br><span class="line">                    |            |    |       |        // 创建表空间，由table-&gt;name确定ibd文件的路径</span><br><span class="line">                    |            |    |       |        // 之后写入ddl log文件，再创建ibd文件</span><br><span class="line">                    |            |    |       |        --&gt; Log_DDL::write_delete_space_log </span><br><span class="line">                    |            |    |       |        |   // 调用Log_DDL::insert_delete_space_log写入ddl log</span><br><span class="line">                    |            |    |       |        --&gt; fil_ibd_create // 这个函数执行完之后才真正创建了ibd文件</span><br><span class="line">                    |            |    |       --&gt; dict_table_add_system_columns // 给表加入系统列（system columns）</span><br><span class="line">                    |            |    |       --&gt; dict_table_add_to_cache // 将要创建的表加入dictionary cache</span><br><span class="line">                    |            |    |       --&gt; Log_DDL::write_remove_cache_log</span><br><span class="line">                    |            |    --&gt; create_clustered_index_when_no_primary // 添加主键索引</span><br><span class="line">                    |            |    |    --&gt; dict_mem_index_create</span><br><span class="line">                    |            |    |    |   // 在内存中申请了index的空间，设置了type、table_name等的参数</span><br><span class="line">                    |            |    |    --&gt; row_create_index_for_mysql</span><br><span class="line">                    |            |    |        --&gt; dict_build_index_def</span><br><span class="line">                    |            |    |            // 创建index定义，不更新系统表，</span><br><span class="line">                    |            |    |            // 更新了index_id，index-&gt;space和index-&gt;trx_id</span><br><span class="line">                    |            |    |        --&gt; dict_index_add_to_cache_w_vcol // 将index写入dictionary cache</span><br><span class="line">                    |            |    |        --&gt; dict_create_index_tree_in_mem</span><br><span class="line">                    |            |    |            --&gt; btr_create // 创建index树，返回root页</span><br><span class="line">                    |            |    |            --&gt; Log_DDL::write_free_tree_log</span><br><span class="line">                    |            |    |                // 这里是先创建了索引然后再写入的ddl log，所以如果这时crash，</span><br><span class="line">                    |            |    |                // 索引还在，却没有办法找到索引对应的空间了</span><br><span class="line">                    |            |    |                // 但是因为这种情况很少见，所以可以接受。</span><br><span class="line">                    |            |    |                // 不过对create table来说，如果file_per_table为true</span><br><span class="line">                    |            |    |                // crash回滚的时候会删除整个表空间的。</span><br><span class="line">                    |            |    --&gt; create_index // 有定义索引的话，会继续创建二级索引，本例没有就暂时不看了</span><br><span class="line">                    |            --&gt; create_table_info_t::create_table_update_global_dd&lt;dd::Table&gt; </span><br><span class="line">                    |                // 更新全局data dictionary，创建tablespace表</span><br><span class="line">                    |            --&gt; create_table_info_t::create_table_update_dict // 更新InnoDB数据库中的表</span><br><span class="line">                    |                --&gt; innobase_copy_frm_flags_from_create_info</span><br><span class="line">                    |                    // 有些flag位存在.frm文件里，拷贝他们过来</span><br><span class="line">                    |                --&gt; dict_stats_update // 更新一些表和索引的统计信息用于优化</span><br><span class="line">                    |                --&gt; innobase_parse_hint_from_comment</span><br><span class="line">                    |                    // 统计表和索引之间的联系，在dictionary中更新</span><br><span class="line">                    --&gt; Dictionary_client::update // 更新持久化了的dictionary对象，但是共享缓存里的内容不变</span><br><span class="line">    --&gt; write_bin_log // 写入binlog文件</span><br><span class="line">    --&gt; Log_DDL::post_ddl // 对文件和树进行适当的清理，删除DDL_LOG中的记录。</span><br><span class="line">                  // 如果事务回滚，则post_ddl()物理删除表空间/ibd (file-per-table)并删除表的索引树。</span><br></pre></td></tr></table></figure><h2 id="典型命令的操作过程"><a href="#典型命令的操作过程" class="headerlink" title="典型命令的操作过程"></a>典型命令的操作过程</h2><p>MySQL提供了一个选项<code>innodb_print_ddl_logs</code>，通过设置该参数可以让MySQL将DDL logs写入stderr，从而可以从错误日志中看到一些典型命令的操作过程。 </p><p><code>log_error_verbosity</code>是<code>log_warnings</code>的替代，当它等于3时表示各种信息都会写入错误日志，包括ERROR，WARNING和INFORMATION。 </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> <span class="keyword">GLOBAL</span> innodb_print_ddl_logs <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> <span class="keyword">GLOBAL</span> log_error_verbosity <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="CREATE-DATABASE"><a href="#CREATE-DATABASE" class="headerlink" title="CREATE DATABASE"></a>CREATE DATABASE</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database my_test;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>创建数据库没有DDL log记录，所以如果创建数据库时中途失败，之后可能需要手动清除数据。</p><h3 id="CREATE-TABLE"><a href="#CREATE-TABLE" class="headerlink" title="CREATE TABLE"></a>CREATE TABLE</h3><p><strong>no index</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> t1(a <span class="type">int</span>, b <span class="type">int</span>) <span class="keyword">partition</span> <span class="keyword">by</span> hash(a) partitions <span class="number">2</span>;</span><br><span class="line">Query OK, <span class="number">0</span><span class="keyword">rows</span> affected(<span class="number">0.59</span> sec)</span><br><span class="line"></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">2</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">2</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p0.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">2</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: REMOVE CACHE, id<span class="operator">=</span><span class="number">3</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1063</span>, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t1#P#p0]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">3</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">4</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">2</span>, index_id<span class="operator">=</span><span class="number">149</span>, page_no<span class="operator">=</span><span class="number">4</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">4</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">5</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">3</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p1.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">5</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: REMOVE CACHE, id<span class="operator">=</span><span class="number">6</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1064</span>, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t1#P#p1]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">6</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">7</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">3</span>, index_id<span class="operator">=</span><span class="number">150</span>, page_no<span class="operator">=</span><span class="number">4</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">7</span></span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">begin</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">end</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br></pre></td></tr></table></figure><p>所有插入的记录都是单独的事务，已经进行操作的反向操作。对于创建table space来说，它的反向操作就是<code>DELETE_SPACE_LOG</code>。</p><p>所得到的ddl log还含有DDL log delete 操作，它其实也是记录，用来删除ddl log。如果最后DDL事务成功提交，delete操作最后就会起到作用，DDL log被清空，但如果DDL事务中途失败了，delete操作会回滚，insert的记录得到保留，这些ddl log会清理遗留的垃圾文件。</p><p>对建表逻辑来说，它包含三类：DELETE SPACE、REMOVE CACHE和FREE。因为建表时对其进行了分区，所以上述三条命令是呈分区倍数出现的。首先建立了第一个分区表，将其写入dictionary cache，再建立索引，然后再对后续的分区表进行同样的操作。ddl log记录的便是这些操作的逆向逻辑：删除数据文件，释放内存中的数据字典信息，删除索引btree。当事务最终提交，ddl log会将这些记录删除。在这里DDL log起到的就是Undo。</p><p><strong>with index</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> t2(a <span class="type">int</span>, b <span class="type">int</span>, key index_a(a)) <span class="keyword">partition</span> <span class="keyword">by</span> hash(a) partitions <span class="number">2</span>;</span><br><span class="line">Query OK, <span class="number">0</span><span class="keyword">rows</span> affected(<span class="number">0.60</span> sec)</span><br><span class="line"></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">8</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">4</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t2#P#p0.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">8</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: REMOVE CACHE, id<span class="operator">=</span><span class="number">9</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1066</span>, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t2#P#p0]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">9</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">10</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">4</span>, index_id<span class="operator">=</span><span class="number">151</span>, page_no<span class="operator">=</span><span class="number">4</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">10</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">11</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">4</span>, index_id<span class="operator">=</span><span class="number">152</span>, page_no<span class="operator">=</span><span class="number">5</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">11</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">12</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">5</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t2#P#p1.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">12</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: REMOVE CACHE, id<span class="operator">=</span><span class="number">13</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1067</span>, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t2#P#p1]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">13</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">14</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">5</span>, index_id<span class="operator">=</span><span class="number">153</span>, page_no<span class="operator">=</span><span class="number">4</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">14</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">15</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">5</span>, index_id<span class="operator">=</span><span class="number">154</span>, page_no<span class="operator">=</span><span class="number">5</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">15</span></span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">begin</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">end</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br></pre></td></tr></table></figure><p>相比于不含key的建表逻辑，可以看到这次的ddl log里多了两条FREE，应该就是对每一个分区建立索引的操作。</p><h3 id="ADD-COLUMN"><a href="#ADD-COLUMN" class="headerlink" title="ADD COLUMN"></a>ADD COLUMN</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> t1 <span class="keyword">add</span> <span class="keyword">column</span> c <span class="type">int</span>;</span><br><span class="line">Query OK, <span class="number">0</span><span class="keyword">rows</span> affected(<span class="number">0.38</span> sec)Records: <span class="number">0</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">begin</span> <span class="keyword">for</span> thread id : <span class="number">12</span>[InnoDB] DDL log post ddl : <span class="keyword">end</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br></pre></td></tr></table></figure><p>没有涉及对物理文件的改动，不需要ddl log来保证原子性，因此也没有ddl log记录。</p><h3 id="ADD-KEY"><a href="#ADD-KEY" class="headerlink" title="ADD KEY"></a>ADD KEY</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> t1 <span class="keyword">add</span> key loc_a(a);</span><br><span class="line">Query OK, <span class="number">0</span><span class="keyword">rows</span> affected(<span class="number">0.12</span> sec)</span><br><span class="line">Records: <span class="number">0</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">16</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">2</span>, index_id<span class="operator">=</span><span class="number">155</span>, page_no<span class="operator">=</span><span class="number">5</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">16</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">17</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">3</span>, index_id<span class="operator">=</span><span class="number">156</span>, page_no<span class="operator">=</span><span class="number">5</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">17</span></span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">begin</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">end</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br></pre></td></tr></table></figure><p>创建索引采用inplace创建的方式，没有临时文件，但如果异常发生的话，依然需要在发生异常时清理临时索引。ADD KEY需要对每一个分区都建立新的索引，这里有两个分区，所以有两条FREE记录。</p><h3 id="DROP-KEY"><a href="#DROP-KEY" class="headerlink" title="DROP KEY"></a>DROP KEY</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> t2 <span class="keyword">add</span> key index_b(b);</span><br><span class="line">Query OK, <span class="number">0</span><span class="keyword">rows</span> affected(<span class="number">4.50</span> sec)</span><br><span class="line">Records: <span class="number">0</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> t2 <span class="keyword">drop</span> key index_b;</span><br><span class="line">Query OK, <span class="number">0</span><span class="keyword">rows</span> affected(<span class="number">0.16</span> sec)</span><br><span class="line">Records: <span class="number">0</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> 关注第二句</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">20</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">4</span>, index_id<span class="operator">=</span><span class="number">157</span>, page_no<span class="operator">=</span><span class="number">6</span>]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">21</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">5</span>, index_id<span class="operator">=</span><span class="number">158</span>, page_no<span class="operator">=</span><span class="number">6</span>]</span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">begin</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">21</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">5</span>, index_id<span class="operator">=</span><span class="number">158</span>, page_no<span class="operator">=</span><span class="number">6</span>]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">20</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">4</span>, index_id<span class="operator">=</span><span class="number">157</span>, page_no<span class="operator">=</span><span class="number">6</span>]</span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">end</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br></pre></td></tr></table></figure><p>DROP KEY的逻辑和前面几条命令的逻辑都不同，在执行阶段它只记录了ddl logs，记下需要删除的索引树，但并没有执行真正的删除，这也是因为如果删了之后发生crash，恢复起来会比较麻烦，它真正的删除操作是在post ddl阶段进行的。这里的DDL log就相当于Redo。</p><h3 id="DROP-COLUMN"><a href="#DROP-COLUMN" class="headerlink" title="DROP COLUMN"></a>DROP COLUMN</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> t1 <span class="keyword">drop</span> <span class="keyword">column</span> c;</span><br><span class="line">Query OK, <span class="number">0</span><span class="keyword">rows</span> affected(<span class="number">0.69</span> sec)</span><br><span class="line">Records: <span class="number">0</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">22</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">6</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1063<span class="number">-4028979805.</span>ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">22</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: REMOVE CACHE, id<span class="operator">=</span><span class="number">23</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1069</span>, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1063<span class="number">-4028979805</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">23</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">24</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">6</span>, index_id<span class="operator">=</span><span class="number">159</span>, page_no<span class="operator">=</span><span class="number">4</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">24</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">25</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">6</span>, index_id<span class="operator">=</span><span class="number">160</span>, page_no<span class="operator">=</span><span class="number">5</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">25</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">26</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">7</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1064<span class="number">-4028979806.</span>ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">26</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: REMOVE CACHE, id<span class="operator">=</span><span class="number">27</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1070</span>, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1064<span class="number">-4028979806</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">27</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">28</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">7</span>, index_id<span class="operator">=</span><span class="number">161</span>, page_no<span class="operator">=</span><span class="number">4</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">28</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">29</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">7</span>, index_id<span class="operator">=</span><span class="number">162</span>, page_no<span class="operator">=</span><span class="number">5</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">29</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">30</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1063</span>]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">31</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1064</span>]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME SPACE, id<span class="operator">=</span><span class="number">32</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">2</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1069<span class="number">-4028979807.</span>ibd, new_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p0.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">32</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME <span class="keyword">TABLE</span>, id<span class="operator">=</span><span class="number">33</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1063</span>, old_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1069<span class="number">-4028979807</span>, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t1#P#p0]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">33</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME SPACE, id<span class="operator">=</span><span class="number">34</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">6</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p0.ibd, new_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1063<span class="number">-4028979805.</span>ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">34</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME <span class="keyword">TABLE</span>, id<span class="operator">=</span><span class="number">35</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1069</span>, old_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t1#P#p0, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1063<span class="number">-4028979805</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">35</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME SPACE, id<span class="operator">=</span><span class="number">36</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">3</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1070<span class="number">-4028979808.</span>ibd, new_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p1.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">36</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME <span class="keyword">TABLE</span>, id<span class="operator">=</span><span class="number">37</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1064</span>, old_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1070<span class="number">-4028979808</span>, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t1#P#p1]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">37</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME SPACE, id<span class="operator">=</span><span class="number">38</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">7</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p1.ibd, new_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1064<span class="number">-4028979806.</span>ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">38</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME <span class="keyword">TABLE</span>, id<span class="operator">=</span><span class="number">39</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1070</span>, old_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t1#P#p1, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1064<span class="number">-4028979806</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">39</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">40</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1063</span>]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">41</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">2</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1069<span class="number">-4028979807.</span>ibd]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">42</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1064</span>]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">43</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">3</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1070<span class="number">-4028979808.</span>ibd]</span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">begin</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">43</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">3</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1070<span class="number">-4028979808.</span>ibd]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">42</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1064</span>]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">41</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">2</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1069<span class="number">-4028979807.</span>ibd]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">40</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1063</span>]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">31</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1064</span>]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">30</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1063</span>]</span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">end</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br></pre></td></tr></table></figure><p>alter table有很多种，这里是最复杂的重建表的逻辑。这种情况下DDL log既是redo，也是undo。<br>执行阶段首先是建立了两个分区表，一开始走了create table的逻辑，然后记录下要删除的原来的表（此时只是记录，留作post-ddl阶段再执行），之后是一系列重命名操作，把旧的表空间和旧的表重命名为新的，这里记录的也是实际执行过程的逆操作。之前的表空间和表名（以A代称）先被重命名成另外一个中间名（以C代称），然后把最初创建的新的表空间和表名（代称为B）重命名为正确的表名，也就是最开始的A名。而被代替的旧表和旧表空间C，先记录下来ddl log，等到post-ddl阶段再做删除。</p><h3 id="RENAME-INDEX"><a href="#RENAME-INDEX" class="headerlink" title="RENAME INDEX"></a>RENAME INDEX</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> t1 renameindex loc_a <span class="keyword">to</span> loc_aa;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.12</span> sec)</span><br><span class="line">Records: <span class="number">0</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">begin</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">end</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br></pre></td></tr></table></figure><p>没有涉及对物理文件的改动，不需要ddl log来保证原子性，因此也没有ddl log记录。</p><h3 id="RENAME-COLUMN"><a href="#RENAME-COLUMN" class="headerlink" title="RENAME COLUMN"></a>RENAME COLUMN</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> t1 <span class="keyword">add</span> key loc_b(b);</span><br><span class="line">Query OK, <span class="number">0</span><span class="keyword">rows</span> affected(<span class="number">4.24</span> sec)Records: <span class="number">0</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> t1 rename <span class="keyword">column</span> b <span class="keyword">to</span> bb;</span><br><span class="line">Query OK, <span class="number">0</span><span class="keyword">rows</span> affected(<span class="number">0.12</span> sec)Records: <span class="number">0</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> 关注第二句</span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">begin</span> <span class="keyword">for</span> thread id : <span class="number">12</span>[InnoDB] DDL log post ddl : <span class="keyword">end</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br></pre></td></tr></table></figure><p>没有涉及对物理文件的改动，不需要ddl log来保证原子性，因此也没有ddl log记录。</p><h3 id="RENAME-TABLE"><a href="#RENAME-TABLE" class="headerlink" title="RENAME TABLE"></a>RENAME TABLE</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> rename <span class="keyword">table</span> t1 <span class="keyword">to</span> t11;</span><br><span class="line">Query OK, <span class="number">0</span><span class="keyword">rows</span> affected(<span class="number">0.11</span> sec)</span><br><span class="line"></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME SPACE, id<span class="operator">=</span><span class="number">8</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">2</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t11#P#p0.ibd, new_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p0.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">8</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME <span class="keyword">TABLE</span>, id<span class="operator">=</span><span class="number">9</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1063</span>, old_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t11#P#p0, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t1#P#p0]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">9</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME SPACE, id<span class="operator">=</span><span class="number">10</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">3</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t11#P#p1.ibd, new_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p1.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">10</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME <span class="keyword">TABLE</span>, id<span class="operator">=</span><span class="number">11</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1064</span>, old_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t11#P#p1, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t1#P#p1]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">11</span></span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">begin</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">end</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br></pre></td></tr></table></figure><p>对每个分区的表空间和表进行了rename操作。</p><h3 id="REBUILD"><a href="#REBUILD" class="headerlink" title="REBUILD"></a>REBUILD</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> t1 engine<span class="operator">=</span>InnoDB;</span><br><span class="line">Query OK, <span class="number">0</span><span class="keyword">rows</span> affected(<span class="number">0.72</span> sec)</span><br><span class="line">Records: <span class="number">0</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">46</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">8</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1069<span class="number">-4028979809.</span>ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">46</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: REMOVE CACHE, id<span class="operator">=</span><span class="number">47</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1071</span>, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1069<span class="number">-4028979809</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">47</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">48</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">8</span>, index_id<span class="operator">=</span><span class="number">165</span>, page_no<span class="operator">=</span><span class="number">4</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">48</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">49</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">8</span>, index_id<span class="operator">=</span><span class="number">166</span>, page_no<span class="operator">=</span><span class="number">5</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">49</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">50</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">8</span>, index_id<span class="operator">=</span><span class="number">167</span>, page_no<span class="operator">=</span><span class="number">6</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">50</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">51</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">9</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1070<span class="number">-4028979810.</span>ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">51</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: REMOVE CACHE, id<span class="operator">=</span><span class="number">52</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1072</span>, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1070<span class="number">-4028979810</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">52</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">53</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">9</span>, index_id<span class="operator">=</span><span class="number">168</span>, page_no<span class="operator">=</span><span class="number">4</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">53</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">54</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">9</span>, index_id<span class="operator">=</span><span class="number">169</span>, page_no<span class="operator">=</span><span class="number">5</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">54</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">55</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">9</span>, index_id<span class="operator">=</span><span class="number">170</span>, page_no<span class="operator">=</span><span class="number">6</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">55</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">56</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1069</span>]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">57</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1070</span>]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME SPACE, id<span class="operator">=</span><span class="number">58</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">6</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1071<span class="number">-4028979811.</span>ibd, new_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p0.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">58</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME <span class="keyword">TABLE</span>, id<span class="operator">=</span><span class="number">59</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1069</span>, old_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1071<span class="number">-4028979811</span>, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t1#P#p0]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">59</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME SPACE, id<span class="operator">=</span><span class="number">60</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">8</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p0.ibd, new_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1069<span class="number">-4028979809.</span>ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">60</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME <span class="keyword">TABLE</span>, id<span class="operator">=</span><span class="number">61</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1071</span>, old_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t1#P#p0, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1069<span class="number">-4028979809</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">61</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME SPACE, id<span class="operator">=</span><span class="number">62</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">7</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1072<span class="number">-4028979812.</span>ibd, new_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p1.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">62</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME <span class="keyword">TABLE</span>, id<span class="operator">=</span><span class="number">63</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1070</span>, old_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1072<span class="number">-4028979812</span>, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t1#P#p1]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">63</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME SPACE, id<span class="operator">=</span><span class="number">64</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">9</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p1.ibd, new_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1070<span class="number">-4028979810.</span>ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">64</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME <span class="keyword">TABLE</span>, id<span class="operator">=</span><span class="number">65</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1072</span>, old_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t1#P#p1, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1070<span class="number">-4028979810</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">65</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">66</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1069</span>]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">67</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">6</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1071<span class="number">-4028979811.</span>ibd]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">68</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1070</span>]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">69</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">7</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1072<span class="number">-4028979812.</span>ibd]</span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">begin</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">69</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">7</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1072<span class="number">-4028979812.</span>ibd]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">68</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1070</span>]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">67</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">6</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1071<span class="number">-4028979811.</span>ibd]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">66</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1069</span>]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">57</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1070</span>]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">56</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1069</span>]</span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">end</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br></pre></td></tr></table></figure><p>rebuild的逻辑和alter table … add column一样，都是重建表，二者的ddl log也极其相似，在这里就不再重复rebuild的实现逻辑了。</p><h3 id="CHANGE-COLUMN"><a href="#CHANGE-COLUMN" class="headerlink" title="CHANGE COLUMN"></a>CHANGE COLUMN</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> t1 change <span class="keyword">column</span> bb b <span class="type">char</span>(<span class="number">10</span>);</span><br><span class="line">Query OK, <span class="number">0</span><span class="keyword">rows</span> affected(<span class="number">5.28</span> sec)</span><br><span class="line">Records: <span class="number">0</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">70</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">10</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>e525_c#P#p0.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">70</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: REMOVE CACHE, id<span class="operator">=</span><span class="number">71</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1073</span>, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>e525_c#P#p0]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">71</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">72</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">10</span>, index_id<span class="operator">=</span><span class="number">171</span>, page_no<span class="operator">=</span><span class="number">4</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">72</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">73</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">10</span>, index_id<span class="operator">=</span><span class="number">172</span>, page_no<span class="operator">=</span><span class="number">5</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">73</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">74</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">10</span>, index_id<span class="operator">=</span><span class="number">173</span>, page_no<span class="operator">=</span><span class="number">6</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">74</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">75</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">11</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>e525_c#P#p1.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">75</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: REMOVE CACHE, id<span class="operator">=</span><span class="number">76</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1074</span>, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>e525_c#P#p1]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">76</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">77</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">11</span>, index_id<span class="operator">=</span><span class="number">174</span>, page_no<span class="operator">=</span><span class="number">4</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">77</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">78</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">11</span>, index_id<span class="operator">=</span><span class="number">175</span>, page_no<span class="operator">=</span><span class="number">5</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">78</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">79</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">11</span>, index_id<span class="operator">=</span><span class="number">176</span>, page_no<span class="operator">=</span><span class="number">6</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">79</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME SPACE, id<span class="operator">=</span><span class="number">80</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">8</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#sql2<span class="operator">-</span>e525<span class="operator">-</span>c#P#p0.ibd, new_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p0.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">80</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME <span class="keyword">TABLE</span>, id<span class="operator">=</span><span class="number">81</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1071</span>, old_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#sql2<span class="operator">-</span>e525<span class="operator">-</span>c#P#p0, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t1#P#p0]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">81</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME SPACE, id<span class="operator">=</span><span class="number">82</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">9</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#sql2<span class="operator">-</span>e525<span class="operator">-</span>c#P#p1.ibd, new_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p1.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">82</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME <span class="keyword">TABLE</span>, id<span class="operator">=</span><span class="number">83</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1072</span>, old_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#sql2<span class="operator">-</span>e525<span class="operator">-</span>c#P#p1, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t1#P#p1]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">83</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME SPACE, id<span class="operator">=</span><span class="number">84</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">10</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p0.ibd, new_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>e525_c#P#p0.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">84</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME <span class="keyword">TABLE</span>, id<span class="operator">=</span><span class="number">85</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1073</span>, old_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t1#P#p0, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>e525_c#P#p0]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">85</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME SPACE, id<span class="operator">=</span><span class="number">86</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">11</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p1.ibd, new_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>e525_c#P#p1.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">86</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME <span class="keyword">TABLE</span>, id<span class="operator">=</span><span class="number">87</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1074</span>, old_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t1#P#p1, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>e525_c#P#p1]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">87</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">88</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1071</span>]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">89</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">8</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#sql2<span class="operator">-</span>e525<span class="operator">-</span>c#P#p0.ibd]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">90</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1072</span>]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">91</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">9</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#sql2<span class="operator">-</span>e525<span class="operator">-</span>c#P#p1.ibd]</span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">begin</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">91</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">9</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#sql2<span class="operator">-</span>e525<span class="operator">-</span>c#P#p1.ibd]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">90</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1072</span>]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">89</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">8</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#sql2<span class="operator">-</span>e525<span class="operator">-</span>c#P#p0.ibd]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">88</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1071</span>]</span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">end</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">begin</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">end</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br></pre></td></tr></table></figure><p>和rebuild和alter table … add column也很相似，首先也是走了建表的逻辑，创建了name前缀为<code>#sql-e525_c</code>的表和表空间，之前的一通操作之后这里有三个key（包含默认的primary），所以有三个FREE的逻辑。之后就是重命名的逻辑，借助一个中间名<code>#sql2-e525-c</code>（注意最后下划线不一样），把新创建的表和表空间和之前的进行交换，原来的表和表空间重命名为#sql2-e525-c 开头的文件，新生成的<code>#sql-e525_c</code>开头的表和表空间重命名为正确的名字（<code>t1#P#p0</code>等），最后记录删除旧表和表空间的log，也就是现在开头为<code>#sql2-e525-c</code>的表空间和表，在post-ddl阶段执行。</p><h3 id="MODIFY-COLUMN"><a href="#MODIFY-COLUMN" class="headerlink" title="MODIFY COLUMN"></a>MODIFY COLUMN</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> t1 modify <span class="keyword">column</span> b <span class="type">int</span>;</span><br><span class="line">Query OK, <span class="number">0</span><span class="keyword">rows</span> affected(<span class="number">0.89</span> sec)</span><br><span class="line">Records: <span class="number">0</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">92</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">12</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>e525_c#P#p0.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">92</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: REMOVE CACHE, id<span class="operator">=</span><span class="number">93</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1076</span>, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>e525_c#P#p0]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">93</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">94</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">12</span>, index_id<span class="operator">=</span><span class="number">177</span>, page_no<span class="operator">=</span><span class="number">4</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">94</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">95</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">12</span>, index_id<span class="operator">=</span><span class="number">178</span>, page_no<span class="operator">=</span><span class="number">5</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">95</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">96</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">12</span>, index_id<span class="operator">=</span><span class="number">179</span>, page_no<span class="operator">=</span><span class="number">6</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">96</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">97</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">13</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>e525_c#P#p1.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">97</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: REMOVE CACHE, id<span class="operator">=</span><span class="number">98</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1077</span>, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>e525_c#P#p1]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">98</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">99</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">13</span>, index_id<span class="operator">=</span><span class="number">180</span>, page_no<span class="operator">=</span><span class="number">4</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">99</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">100</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">13</span>, index_id<span class="operator">=</span><span class="number">181</span>, page_no<span class="operator">=</span><span class="number">5</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">100</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">101</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">13</span>, index_id<span class="operator">=</span><span class="number">182</span>, page_no<span class="operator">=</span><span class="number">6</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">101</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME SPACE, id<span class="operator">=</span><span class="number">102</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">10</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#sql2<span class="operator">-</span>e525<span class="operator">-</span>c#P#p0.ibd, new_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p0.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">102</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME <span class="keyword">TABLE</span>, id<span class="operator">=</span><span class="number">103</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1073</span>, old_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#sql2<span class="operator">-</span>e525<span class="operator">-</span>c#P#p0, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t1#P#p0]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">103</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME SPACE, id<span class="operator">=</span><span class="number">104</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">11</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#sql2<span class="operator">-</span>e525<span class="operator">-</span>c#P#p1.ibd, new_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p1.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">104</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME <span class="keyword">TABLE</span>, id<span class="operator">=</span><span class="number">105</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1074</span>, old_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#sql2<span class="operator">-</span>e525<span class="operator">-</span>c#P#p1, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t1#P#p1]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">105</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME SPACE, id<span class="operator">=</span><span class="number">106</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">12</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p0.ibd, new_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>e525_c#P#p0.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">106</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME <span class="keyword">TABLE</span>, id<span class="operator">=</span><span class="number">107</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1076</span>, old_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t1#P#p0, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>e525_c#P#p0]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">107</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME SPACE, id<span class="operator">=</span><span class="number">108</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">13</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p1.ibd, new_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>e525_c#P#p1.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">108</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME <span class="keyword">TABLE</span>, id<span class="operator">=</span><span class="number">109</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1077</span>, old_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t1#P#p1, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>e525_c#P#p1]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">109</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">110</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1073</span>]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">111</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">10</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#sql2<span class="operator">-</span>e525<span class="operator">-</span>c#P#p0.ibd]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">112</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1074</span>]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">113</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">11</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#sql2<span class="operator">-</span>e525<span class="operator">-</span>c#P#p1.ibd]</span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">begin</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">113</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">11</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#sql2<span class="operator">-</span>e525<span class="operator">-</span>c#P#p1.ibd]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">112</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1074</span>]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">111</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">10</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#sql2<span class="operator">-</span>e525<span class="operator">-</span>c#P#p0.ibd]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">110</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1073</span>]</span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">end</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">begin</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">end</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br></pre></td></tr></table></figure><p>和CHANGE COLUMN的逻辑一样，就不再多说了。</p><h3 id="TRUNCATE-TABLE"><a href="#TRUNCATE-TABLE" class="headerlink" title="TRUNCATE TABLE"></a>TRUNCATE TABLE</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">truncate</span> <span class="keyword">table</span> t2;</span><br><span class="line">Query OK, <span class="number">0</span><span class="keyword">rows</span> affected(<span class="number">0.65</span> sec)</span><br><span class="line"></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME SPACE, id<span class="operator">=</span><span class="number">114</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">4</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1066<span class="number">-4028979813.</span>ibd, new_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t2#P#p0.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">114</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">115</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1066</span>]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">116</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">4</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1066<span class="number">-4028979813.</span>ibd]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">117</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">14</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t2#P#p0.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">117</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: REMOVE CACHE, id<span class="operator">=</span><span class="number">118</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1079</span>, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t2#P#p0]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">118</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">119</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">14</span>, index_id<span class="operator">=</span><span class="number">183</span>, page_no<span class="operator">=</span><span class="number">4</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">119</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">120</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">14</span>, index_id<span class="operator">=</span><span class="number">184</span>, page_no<span class="operator">=</span><span class="number">5</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">120</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: RENAME SPACE, id<span class="operator">=</span><span class="number">121</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">5</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1067<span class="number">-4028979814.</span>ibd, new_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t2#P#p1.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">121</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">122</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1067</span>]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">123</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">5</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1067<span class="number">-4028979814.</span>ibd]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">124</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">15</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t2#P#p1.ibd]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">124</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: REMOVE CACHE, id<span class="operator">=</span><span class="number">125</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1080</span>, new_file_path<span class="operator">=</span>my_test<span class="operator">/</span>t2#P#p1]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">125</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">126</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">15</span>, index_id<span class="operator">=</span><span class="number">185</span>, page_no<span class="operator">=</span><span class="number">4</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">126</span></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">FREE</span>, id<span class="operator">=</span><span class="number">127</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">15</span>, index_id<span class="operator">=</span><span class="number">186</span>, page_no<span class="operator">=</span><span class="number">5</span>]</span><br><span class="line">[InnoDB] DDL logdelete : <span class="number">127</span></span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">begin</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">123</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">5</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1067<span class="number">-4028979814.</span>ibd]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">122</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1067</span>]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">116</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">4</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>#<span class="keyword">sql</span><span class="operator">-</span>ib1066<span class="number">-4028979813.</span>ibd]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">115</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1066</span>]</span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">end</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br></pre></td></tr></table></figure><p>首先先把旧的表空间找个临时的名称先存起来，记录一下要删除旧的表和这个旧的表空间（先记录，post-ddl再删除），然后走了创建表的逻辑，也就是用空的表空间和表来代替原来的旧的表空间和表。post-ddl阶段删除原来的表空间和表。</p><h3 id="DROP-TABLE"><a href="#DROP-TABLE" class="headerlink" title="DROP TABLE"></a>DROP TABLE</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> t2;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.09</span> sec)</span><br><span class="line"></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">128</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1079</span>]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">129</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">14</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t2#P#p0.ibd]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">130</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1080</span>]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">131</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">15</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t2#P#p1.ibd]</span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">begin</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">131</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">15</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t2#P#p1.ibd]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">130</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1080</span>]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">129</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">14</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t2#P#p0.ibd]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">128</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1079</span>]</span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">end</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br></pre></td></tr></table></figure><p>记录删除操作，留在post-ddl阶段再执行。</p><h3 id="DROP-DATABASE"><a href="#DROP-DATABASE" class="headerlink" title="DROP DATABASE"></a>DROP DATABASE</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database my_test;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.14</span> sec)</span><br><span class="line"></span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">154</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1081</span>]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">155</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">16</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p0.ibd]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">156</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1082</span>]</span><br><span class="line">[InnoDB] DDL log <span class="keyword">insert</span> : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">157</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">17</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p1.ibd]</span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">begin</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">157</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">17</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p1.ibd]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">156</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1082</span>]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DELETE</span> SPACE, id<span class="operator">=</span><span class="number">155</span>, thread_id<span class="operator">=</span><span class="number">12</span>, space_id<span class="operator">=</span><span class="number">16</span>, old_file_path<span class="operator">=</span>.<span class="operator">/</span>my_test<span class="operator">/</span>t1#P#p0.ibd]</span><br><span class="line">[InnoDB] DDL log replay : [DDL record: <span class="keyword">DROP</span>, id<span class="operator">=</span><span class="number">154</span>, thread_id<span class="operator">=</span><span class="number">12</span>, table_id<span class="operator">=</span><span class="number">1081</span>]</span><br><span class="line">[InnoDB] DDL log post ddl : <span class="keyword">end</span> <span class="keyword">for</span> thread id : <span class="number">12</span></span><br></pre></td></tr></table></figure><p>只记录了删除表的操作，也就是只记录了drop table的逻辑，和create database的逻辑相似，涉及创建数据库和删除数据库的操作不受ddl log保护，不支持原子性。</p><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p>[1] <a href="https://dev.mysql.com/doc/refman/8.0/en/atomic-ddl.html">13.1.1 Atomic Data Definition Statement Support</a></p><p>[2] <a href="https://mysqlserverteam.com/atomic-ddl-in-mysql-8-0/">Atomic DDL in MySQL 8.0</a></p><p>[3] <a href="http://mysqlserverteam.com/mysql-8-0-data-dictionary-architecture-and-design/">MySQL 8.0: Data Dictionary Architecture and Design</a></p><p>[4] <a href="http://mysql.taobao.org/monthly/2020/05/05/">MySQL · 源码分析 · 8.0 · DDL的那些事</a></p><p>[5] <a href="http://mysql.taobao.org/monthly/2018/03/02/">MySQL · 源码分析 · 原子DDL的实现过程</a></p><p>[6] <a href="http://mysql.taobao.org/monthly/2018/07/02/">MySQL · 源码分析 · 8.0 原子DDL的实现过程续</a></p><p>[7] <a href="https://developer.aliyun.com/article/692258">深入解读MySQL8.0 新特性 ：Crash Safe DDL</a></p><p>[8] <a href="https://mp.weixin.qq.com/s/yym9E9gkrxqflL5dOTU6BA">Atomic DDL揭秘</a></p>]]></content>
      
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 功能介绍 </tag>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RocksDB入门</title>
      <link href="/2023/07/30/RocksDB%E5%85%A5%E9%97%A8/"/>
      <url>/2023/07/30/RocksDB%E5%85%A5%E9%97%A8/</url>
      
        <content type="html"><![CDATA[<p><a href="/slices/MyRocks-intro.pptx" download="MyRocks-intro.pptx">下载PPT</a></p><div class="pdfobject-container" data-target="/pdf/MyRocks-intro.pdf" data-height="500px"></div>]]></content>
      
      
      <categories>
          
          <category> RocksDB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RocksDB </tag>
            
            <tag> 功能介绍 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
